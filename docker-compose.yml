# ğŸ³ droid2api - Docker Compose é…ç½®
# ç‰ˆæœ¬ï¼šv1.4.0+
# æ–‡æ¡£ï¼šDOCKER_DEPLOY.md

version: '3.8'

services:
  droid2api:
    build: .
    container_name: droid2api
    ports:
      - "3000:3000"
    environment:
      # ===== ğŸ” äº”çº§è®¤è¯é…ç½®ï¼ˆæŒ‰ä¼˜å…ˆçº§é€‰æ‹©ï¼Œè‡³å°‘é…ç½®ä¸€ä¸ªï¼‰ =====

      # 1ï¸âƒ£ æœ€é«˜ä¼˜å…ˆçº§ï¼šå›ºå®šAPIå¯†é’¥ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼Œå•å¯†é’¥æ¨¡å¼ï¼‰
      - FACTORY_API_KEY=${FACTORY_API_KEY}

      # 2ï¸âƒ£ ï¼ˆå¯†é’¥æ± ç®¡ç†åœ¨ Web ç•Œé¢æ·»åŠ ï¼Œæ— éœ€ç¯å¢ƒå˜é‡ï¼‰

      # 3ï¸âƒ£ ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šOAuth è‡ªåŠ¨åˆ·æ–°ï¼ˆ6å°æ—¶è‡ªåŠ¨åˆ·æ–°ï¼‰
      - DROID_REFRESH_KEY=${DROID_REFRESH_KEY}

      # ===== ğŸ”‘ ç®¡ç†åå°é…ç½®ï¼ˆå¼ºçƒˆæ¨èï¼‰ =====
      - ADMIN_ACCESS_KEY=${ADMIN_ACCESS_KEY:-your-admin-password-change-me}

      # ===== ğŸ›¡ï¸ å®¢æˆ·ç«¯è®¿é—®æ§åˆ¶ï¼ˆå¯é€‰ï¼‰ =====
      - API_ACCESS_KEY=${API_ACCESS_KEY}

      # ===== ğŸš€ æœåŠ¡å™¨é…ç½®ï¼ˆå¯é€‰ï¼‰ =====
      - PORT=${PORT:-3000}
      - NODE_ENV=${NODE_ENV:-production}

      # ===== ğŸ¯ å¯†é’¥æ± é…ç½®ï¼ˆå¯é€‰ï¼‰ =====
      - KEY_POOL_ALGORITHM=${KEY_POOL_ALGORITHM:-round-robin}
      - KEY_POOL_RETRY_ENABLED=${KEY_POOL_RETRY_ENABLED:-true}
      - KEY_POOL_RETRY_MAX=${KEY_POOL_RETRY_MAX:-3}
      - KEY_POOL_AUTO_BAN_ENABLED=${KEY_POOL_AUTO_BAN_ENABLED:-true}
      - KEY_POOL_BAN_402=${KEY_POOL_BAN_402:-true}

      # ===== ğŸ”¥ Redis ç¼“å­˜é…ç½®ï¼ˆå¯é€‰ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼‰ =====
      # å¯ç”¨ Redis å¯æå‡æ€§èƒ½ 30-50%ï¼
      # - REDIS_HOST=redis
      # - REDIS_PORT=6379
      # - REDIS_PASSWORD=
      # - REDIS_DB=0

      # ===== âš¡ é›†ç¾¤æ¨¡å¼é…ç½®ï¼ˆå¯é€‰ï¼Œæè‡´æ€§èƒ½ï¼‰ =====
      # å¯ç”¨é›†ç¾¤æ¨¡å¼å¯æå‡æ€§èƒ½ N å€ï¼ˆN = CPUæ ¸å¿ƒæ•°ï¼‰ï¼
      # - CLUSTER_MODE=true
      # - CLUSTER_WORKERS=4

    volumes:
      # ğŸ’¾ æŒä¹…åŒ–æ•°æ®ç›®å½•ï¼ˆæ¨èï¼å®¹å™¨é‡å¯ä¸ä¸¢å¤±å¯†é’¥æ± æ•°æ®ï¼‰
      - ./data:/app/data
      # ğŸ“ æŒä¹…åŒ–æ—¥å¿—ç›®å½•ï¼ˆå¯é€‰ï¼‰
      - ./logs:/app/logs

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # depends_on:
    #   - redis  # å¦‚æœå¯ç”¨ Redisï¼Œå–æ¶ˆæ³¨é‡Šæ­¤è¡Œ

  # ===== ğŸ”¥ Redis ç¼“å­˜æœåŠ¡ï¼ˆå¯é€‰ï¼‰ =====
  # é€‚ç”¨åœºæ™¯ï¼šæ—¥å‡è¯·æ±‚ > 50ä¸‡
  # å¯ç”¨æ–¹å¼ï¼šå–æ¶ˆæ³¨é‡Šä»¥ä¸‹é…ç½®ï¼Œå¹¶åœ¨ droid2api æœåŠ¡ä¸­è®¾ç½® REDIS_HOST=redis

  # redis:
  #   image: redis:alpine
  #   container_name: droid2api-redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis-data:/data
  #   command: redis-server --appendonly yes
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 3

# ===== ğŸ“¦ æ•°æ®å·å®šä¹‰ï¼ˆå¯é€‰ï¼‰ =====
# å¦‚æœä½¿ç”¨å‘½åå·è€Œéç»‘å®šæŒ‚è½½ï¼Œå–æ¶ˆæ³¨é‡Šä»¥ä¸‹é…ç½®

# volumes:
#   redis-data:

# ===== ğŸ“– ä½¿ç”¨è¯´æ˜ =====
#
# å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥æå®šï¼‰ï¼š
#   1. cp .env.example .env
#   2. ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®è‡³å°‘ä¸€ä¸ªè®¤è¯æ–¹å¼å’Œ ADMIN_ACCESS_KEY
#   3. docker-compose up -d
#
# å¸¸ç”¨å‘½ä»¤ï¼š
#   å¯åŠ¨æœåŠ¡ï¼šdocker-compose up -d
#   æŸ¥çœ‹æ—¥å¿—ï¼šdocker-compose logs -f
#   åœæ­¢æœåŠ¡ï¼šdocker-compose down
#   é‡å¯æœåŠ¡ï¼šdocker-compose restart
#   æŸ¥çœ‹çŠ¶æ€ï¼šdocker-compose ps
#
# è®¿é—®æœåŠ¡ï¼š
#   API: http://localhost:3000
#   ç®¡ç†ç•Œé¢: http://localhost:3000/ (éœ€è¦ ADMIN_ACCESS_KEY)
#   å¥åº·æ£€æŸ¥: http://localhost:3000/v1/models
#
# æ€§èƒ½ä¼˜åŒ–ï¼š
#   - é˜¶æ®µ1ï¼ˆé»˜è®¤ï¼‰ï¼š2000+ RPSï¼Œæ— éœ€é…ç½®
#   - é˜¶æ®µ2ï¼ˆRedisï¼‰ï¼š3000+ RPSï¼Œå–æ¶ˆæ³¨é‡Š redis æœåŠ¡é…ç½®
#   - é˜¶æ®µ3ï¼ˆé›†ç¾¤ï¼‰ï¼š10000+ RPSï¼Œå¯ç”¨ CLUSTER_MODE=true
#
# è¯¦ç»†æ–‡æ¡£ï¼š
#   - DOCKER_DEPLOY.md - Docker éƒ¨ç½²æŒ‡å—
#   - README.md - é¡¹ç›®æ–‡æ¡£
#   - docs/MULTI_TIER_POOL.md - å¤šçº§å¯†é’¥æ± è¯´æ˜
